{% extends "base.html" %}

{% block title %}MongoDB Quiz - Examen{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Exam Header -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="bi bi-clipboard-check text-success"></i> Examen de MongoDB
                </h2>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Total de preguntas:</strong> {{ questions|length }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Dificultad:</strong>
                            <span class="badge bg-success">Fácil: {{ difficulty_summary.easy }}</span>
                            <span class="badge bg-warning">Media: {{ difficulty_summary.medium }}</span>
                            <span class="badge bg-danger">Difícil: {{ difficulty_summary.hard }}</span>
                        </p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Tiempo:</strong>
                            <span id="timer" class="badge bg-info">00:00</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Form -->
        <form action="{{ url_for('submit_exam') }}" method="POST" id="examForm">
            {% for question in questions %}
            <div class="card shadow-sm mb-4 question-card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Pregunta {{ question.number }} de {{ questions|length }}</h5>
                        <div>
                            <span class="badge bg-{{ 'success' if question.difficulty == 'easy' else 'warning' if question.difficulty == 'medium' else 'danger' }}">
                                {{ question.difficulty|capitalize }}
                            </span>
                            <span class="badge bg-secondary">
                                {{ question.question_type|capitalize }}
                            </span>
                            {% if question.dataset_reference and question.dataset_reference != 'N/A' %}
                            <span class="badge bg-info">
                                <i class="bi bi-database"></i> {{ question.dataset_reference }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="question-text mb-4">{{ question.question_text }}</p>

                    <div class="options-container">
                        {% for option in ['a', 'b', 'c', 'd', 'e'] %}
                        <div class="form-check mb-3 option-item">
                            <input class="form-check-input" type="radio"
                                   name="question_{{ question.id }}"
                                   id="q{{ question.id }}_{{ option }}"
                                   value="{{ option }}"
                                   required>
                            <label class="form-check-label" for="q{{ question.id }}_{{ option }}">
                                <strong>{{ option|upper }})</strong> {{ question['option_' + option] }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                        <i class="bi bi-check-circle-fill"></i> Enviar examen
                    </button>
                    <p class="text-muted mt-2 mb-0">
                        <small>Asegúrate de haber respondido todas las preguntas</small>
                    </p>
                </div>
            </div>
        </form>

        <!-- Progress Indicator -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div class="card shadow">
                <div class="card-body">
                    <h6 class="card-title">Progreso</h6>
                    <div class="progress mb-2" style="height: 25px;">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar"
                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    <p class="mb-0 small text-muted">
                        <span id="answeredCount">0</span> de {{ questions|length }} respondidas
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Timer
    let startTime = new Date();
    setInterval(function() {
        let elapsed = Math.floor((new Date() - startTime) / 1000);
        let minutes = Math.floor(elapsed / 60);
        let seconds = elapsed % 60;
        document.getElementById('timer').textContent =
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    }, 1000);

    // Progress tracking
    const totalQuestions = {{ questions|length }};
    const radioInputs = document.querySelectorAll('input[type="radio"]');

    function updateProgress() {
        const answered = new Set();
        radioInputs.forEach(input => {
            if (input.checked) {
                const questionId = input.name;
                answered.add(questionId);
            }
        });

        const count = answered.size;
        const percentage = Math.round((count / totalQuestions) * 100);

        document.getElementById('answeredCount').textContent = count;
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressBar').textContent = percentage + '%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);

        // Change color based on progress
        const progressBar = document.getElementById('progressBar');
        progressBar.className = 'progress-bar';
        if (percentage < 50) {
            progressBar.classList.add('bg-danger');
        } else if (percentage < 100) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-success');
        }
    }

    radioInputs.forEach(input => {
        input.addEventListener('change', updateProgress);
    });

    // Confirm before leaving
    window.addEventListener('beforeunload', function(e) {
        e.preventDefault();
        e.returnValue = '';
    });

    // Remove confirmation when submitting
    document.getElementById('examForm').addEventListener('submit', function() {
        window.removeEventListener('beforeunload', arguments.callee);
    });

    // Scroll to top when clicking submit
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        const unanswered = totalQuestions - document.querySelectorAll('input[type="radio"]:checked').length / 5;
        if (unanswered > 0) {
            if (!confirm(`Tienes ${unanswered} preguntas sin responder. ¿Deseas enviar el examen de todos modos?`)) {
                e.preventDefault();
            }
        }
    });
</script>
{% endblock %}
